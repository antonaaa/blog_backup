---
title: 传输控制协议（3）拥塞控制 
date: 2016-08-12 21:01:26
tags:
- 运输层
- TCP
categories:
- 计算机网络
---

> 所谓拥塞控制，就是防止过多的数据注入到网络中，这样可以使网络中的路由器和链路不至于过载。所以这是一个**全局性的过程**，所有的主机都必须参与其中，从而营造一个更多的网络环境。

<!-- more -->

4种用于拥塞控制的算法：慢开始(slow-start)、拥塞避免(congestion avoidance)、快重传(fast retransmit)、快恢复(fast recovery)。

## 慢开始和拥塞避免

发送方维护一个**拥塞窗口cwnd**，发送方窗口的大小取决于接收端的窗口大小rwnd和拥塞窗口大小cwnd，**发送方窗口大小 = min{ rwnd , cwnd }**;

发送方控制拥塞窗口cwnd大小的原则是：**只要网络没有出现拥塞，那么拥塞窗口就再增大一些**，以便将更多的分组发送出去；如果网络出现了拥塞，那么就使拥塞窗口减小一些，以减少注入到网络中的分组数。至于如何增大和减小看具体的算法。

### 慢开始算法

> 当主机刚开始发送数据时，尚不清楚网络的拥塞状态，不宜一下子发送太多数据出去，所以应该慢慢试探能够发送多少数据。所以先让cwnd = 1 * MSS，发送方每收到一个对新报文段的确认（对于重传报文的确认不算在内）就将cwnd += MSS，可以看出来在不发生重传的情况下，每经过一个往返时间RTT，cwnd的值就会加倍。该算法的目的是通过不断的探测观察，使得新分组进入网络的速率应该与另一方返回确认的速率相同。

<p style ="color:blue">
开始	--->		cwnd = 1 \* MSS
经过一个RTT --->	cwnd = 2 \* MSS
经过二个RTT --->	cwnd = 4 \* MSS
经过三个RTT	--->	cwnd = 8 \* MSS
....
</p>
![slow-start](slow-start.png)


可以看出来慢开始算法的不是指cwnd的增长速度慢，而是指主机刚开始发送数据时，只能够发送一个报文段（目的是试探一下网络的拥塞情况）。由于慢开始算法的增长速度太快了，所以为了防止cwnd增长过快而引起网络拥塞还需要用到**拥塞避免算法**。

### 拥塞避免算法

慢开始算法使得cwnd增长非常迅速，从而容易网络拥塞，所以需要设置一个**慢开始门限ssthresh**，当cwnd大于ssthresh时，就让其增长得不那么迅速。具体的使用方法如下：
+ 当cwnd < ssthresh时，使用慢开始算法
+ 当cwnd > ssthresh时，停止使用慢开始算法，而改用拥塞避免算法。
+ 当cwnd = ssthresh时，即可使用慢开始算法，又可使用拥塞避免算法。

> 拥塞算法的思路是让cwnd缓慢增大，即每经过一个往返时间RTT，cwnd的大小增加一个MSS，而不是像慢开始算法那样加倍。

如下图当cwnd < ssthresh时，cwnd的增长非常迅速； 当cwnd >= ssthresh时，cwnd就以线性的方式增加了。

![慢启动和拥塞避免算法举例](slow-start-and-ssthresh.png)


无论是在慢开始阶段还是在拥塞避免阶段，只要发送方判断网络出现了拥塞（即发现有报文没有按时收到确认），那么就将慢开始门限设为出现拥塞时发送发窗口值的一半，然后把让拥塞窗口cwnd = 1 * MSS，执行慢开始算法。这样做的目的是迅速减少主机发送到网络中的分组数，使得发生拥塞的路由器有足够的时间把队列中积压的分组处理完毕。

以上两个算法合起来**加法增大乘法减小**AIMD（Additive Increase Multiplicative Decrease）。 **乘法减小**即不管在慢开始还是在拥塞避免阶段，只要一发生拥塞，就把慢启动门限ssthresh减半，所以当网络繁忙时ssthresh下降得还快，以大大减少注入到网络中的分组数。 **加法增大**是指在拥塞避免阶段时，用拥塞窗口缓慢增加，以防止网络过早出现拥塞。

## 快重传和快恢复

我们知道TCP会在某个分组的**超时计时器**到期时，才会重传该分组。而**快重传算法**则不这么做。
快重传算法每收到一个失序的报文段就立即发出重复确认，该重复确认是对已经收到最后一个有序报文段的确认。
如下图，当收到失序的M4,M5,M6时，都对M2进行了重复确认，这表示有报文丢失了，于是发送方立即重传丢失的报文，而无需等待超时计时器过期。这就是快重传算法。

![快重传](fast_retransmit.png)

接下来执行的不是慢启动算法，而是拥塞避免算法。这就叫做快恢复算法。

1. 当收到3个重复的ACK报文时，将ssthresh设置当前拥塞窗口cwnd的一半。重传丢失的报文。减低ssthresh是**防止**网络拥塞。
2. 又由于连续收到3个重复的ACK报文，说明网络**很有可能没有发生拥塞**，所以让拥塞窗口cwnd = ssthresh，随后开始执行拥塞避免算法。



所以从上面的描述可以看出，在使用快恢复算法时，慢开始算法只有在TCP建立连接和超时计时器过期的情况下使用。采用这样的拥塞控制方法，使得在报文丢失时能够快速重传，而且避免了执行慢开始算法，从而提高了传输效率。
